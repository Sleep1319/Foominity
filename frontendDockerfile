FROM node:20-bookworm AS build
WORKDIR /app/frontend

COPY frontend/package*.json ./

RUN npm i -g npm@11
RUN rm -f package-lock.json
RUN npm install --legacy-peer-deps

COPY frontend/. .
ENV NODE_OPTIONS=--max-old-space-size=2048
ENV CI=false
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL
RUN npm run build


# --- serve ---
FROM nginx:alpine
COPY --from=build /app/frontend/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx","-g","daemon off;"]